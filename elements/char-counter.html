<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="char-counter" attributes="fieldId counterLabel maxChars">
	<template>
		<textarea id="unique" on-keyup="{{onKeyup}}"></textarea>
		<div>{{counter}}</div>
	</template>
	<script>
		"use strict";

		Polymer("char-counter", {

			// public API
			fieldId: null,
			maxChars: null,
			counterLabel: "{{chars}} chars",

			// private
			field: null,

			ready: function() {
				var defaultTextarea = this.shadowRoot.querySelector("#unique");

				// no outside element has been targetted as the textbox / textarea - use our own!
				if (this.fieldId === null) {
					if (this.innerHTML) {
						defaultTextarea.value = this.innerHTML;
					}
					this.field = defaultTextarea;
				} else {
					defaultTextarea.style.display = "none";

					// check the ID exists and that it's a textbox or textarea
					this.field = document.getElementById(this.fieldId);
					var self = this;
					this.on(this.field, "keyup", function(e) {
						self.updateCounter(e.target.value.length);
					});
				}

				this.updateCounter(this.field.value.length);
			},

			onKeyup: function(e, detail, sender) {
				this.updateCounter(sender.value.length);
			},

			// TODO this looks slow...
			updateCounter: function(count) {
				this.counter = this.counterLabel.replace(/\{\{chars\}\}/, count);
			},

			/**
			 * Cross Browser helper to addEventListener.
			 * https://gist.github.com/eduardocereto/955642
			 *
			 * @param {HTMLElement} obj The Element to attach event to.
			 * @param {string} evt The event that will trigger the binded function.
			 * @param {function(event)} fnc The function to bind to the element.
			 * @return {boolean} true if it was successfuly binded.
			 */
			on: function(obj, evt, fnc) {
				// W3C model
				if (obj.addEventListener) {
					obj.addEventListener(evt, fnc, false);
					return true;
				}
				// Microsoft model
				else if (obj.attachEvent) {
					return obj.attachEvent('on' + evt, fnc);
				}
				// Browser don't support W3C or MSFT model, go on with traditional
				else {
					evt = 'on'+evt;
					if(typeof obj[evt] === 'function'){
						// Object already has a function on traditional
						// Let's wrap it with our own function inside another function
						fnc = (function(f1,f2){
							return function(){
								f1.apply(this,arguments);
								f2.apply(this,arguments);
							}
						})(obj[evt], fnc);
					}
					obj[evt] = fnc;
					return true;
				}
				return false;
			}

			// exposed API

		});
	</script>
</polymer-element>